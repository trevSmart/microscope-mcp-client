# Workflow per publicar a NPM
name: Publish to NPM

on:
  workflow_run:
    workflows: ["Update Package Version"]
    types: [completed]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npm test

  publish-npm:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download updated package.json
        uses: actions/download-artifact@v4
        with:
          name: updated-package-json
          path: .
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/
      - run: npm ci
      - run: npm run build
      - name: Create npm version without scope
        run: |
          # Create a copy of package.json for npm without scope
          cp package.json package-npm.json
          # Remove scope from name for npm
          node -e "
            const pkg = require('./package-npm.json');
            pkg.name = 'microscope-mcp-client';
            delete pkg.publishConfig;
            require('fs').writeFileSync('./package-npm.json', JSON.stringify(pkg, null, 2) + '\n');
          "
      - name: Publish to npm
        run: |
          # Temporarily rename package files for npm publish
          mv package.json package-github.json
          mv package-npm.json package.json
          npm publish --registry https://registry.npmjs.org/
          # Restore original package.json
          mv package.json package-npm.json
          mv package-github.json package.json
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}